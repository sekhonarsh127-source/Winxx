<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKOOLMATE - teacher</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --primary: #2c3e50; --accent: #4a90e2; --danger: #e74c3c; --success: #2ecc71; --text-main: #333; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 60px; color: var(--text-main); user-select: none; }
        /* --- LOGO STYLE --- */
.school-logo {
    display: block;
    margin: 0 auto 15px auto; /* Centers the logo */
    max-width: 200px;         /* Max width limit */
    width: 100%;              /* Responsive */
    height: auto;
}
        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { width: 85%; max-width: 350px; text-align: center; }
        .login-icon { font-size: 50px; color: var(--accent); margin-bottom: 20px; }
        
        /* HEADER */
        .header { background: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .h-title { font-weight: 800; font-size: 20px; color: var(--primary); }
        .h-sub { font-size: 11px; color: var(--accent); font-weight: bold; text-transform: uppercase; }

        /* GRID */
        .admin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .admin-card { background: var(--card-bg); border-radius: 18px; padding: 20px 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .admin-card:active { transform: scale(0.96); }
        .icon-box { width: 50px; height: 50px; border-radius: 14px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }
        .card-name { font-size: 12px; font-weight: 700; color: #444; }

        /* SCREENS */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f6f9; z-index: 1500; transform: translateX(100%); transition: transform 0.3s; overflow-y: auto; }
        .screen.active { transform: translateX(0); }
        .fs-header { background: #fff; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .fs-title { font-size: 18px; font-weight: bold; margin-left: 15px; flex: 1; }

        /* FORMS */
        .form-section { background: white; padding: 20px; margin: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .form-group { margin-bottom: 15px; text-align: left; }
        .label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 5px; }
        .input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; outline: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--accent); color: white; }
        .manage-item { background: white; padding: 12px; margin: 10px 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border-left: 4px solid var(--accent); }
        
        .flex-row { display: flex; gap: 10px; } .flex-col { flex: 1; }
        
        /* Profile View */
        .profile-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; }
        .p-lbl { font-weight:bold; color:#666; font-size:13px; }
        .p-val { color:#333; font-weight:bold; font-size:13px; }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
        <!-- SCHOOL LOGO -->

<img src="https://i.ibb.co/xSYJ7V1g/1769350192874.png" class="school-logo" alt="School Logo" style="width:200px; display:block; margin: 0 auto 15px auto;">            <i class="fa-solid fa-chalkboard-user login-icon"></i>
            <h2 style="color:var(--primary); margin:0;">Teacher Portal</h2>
            <p style="color:#777; font-size:13px; margin-bottom:30px;">Login to manage classes</p>
            
            <div class="form-group">
                <input type="email" id="login_email" class="input" placeholder="Teacher Email">
            </div>
            <div class="form-group">
                <input type="password" id="login_pass" class="input" placeholder="Password">
            </div>
            
            <button class="btn btn-primary" onclick="handleLogin()">Secure Login</button>
            <p id="login_msg" style="color:red; font-size:12px; margin-top:15px;"></p>
        </div>
    </div>

    <!-- 2. MAIN APP (Hidden until login) -->
    <div id="main-app" style="display: none;">
        
        <!-- HEADER -->
        <div class="header">
            <div>
                <div class="h-title">Teacher Panel</div>
                <div class="h-sub" id="teacher_info">Fetching details...</div>
            </div>
            <i class="fa-solid fa-right-from-bracket" style="color: var(--danger); font-size: 20px; cursor: pointer;" onclick="logout()"></i>
        </div>

        <!-- MAIN GRID -->
        <div class="admin-grid">
            <div class="admin-card" onclick="openScreen('homeworkScreen')">
                <div class="icon-box" style="background: #4facfe;"><i class="fa-solid fa-book-open"></i></div>
                <div class="card-name">Upload Homework</div>
            </div>
            <div class="admin-card" onclick="openScreen('noticeScreen')">
                <div class="icon-box" style="background: #f6d365;"><i class="fa-solid fa-bullhorn"></i></div>
                <div class="card-name">Class Notice</div>
            </div>
            <div class="admin-card" onclick="openScreen('leaveScreen')">
                <div class="icon-box" style="background: #ff758c;"><i class="fa-solid fa-bell"></i></div>
                <div class="card-name">Student Leaves</div>
            </div>
            <div class="admin-card" onclick="openScreen('profileScreen')">
                <div class="icon-box" style="background: #868f96;"><i class="fa-solid fa-user"></i></div>
                <div class="card-name">My Profile</div>
            </div>
        </div>

        <!-- SCREENS -->
        
        <!-- PROFILE SCREEN (NEW) -->
        <div id="profileScreen" class="screen">
            <div class="fs-header"><i class="fa-solid fa-arrow-left" onclick="closeScreen('profileScreen')" style="padding:10px;"></i><span class="fs-title">My Profile</span></div>
            <div class="form-section" style="text-align:center;">
                <div style="width:80px; height:80px; background:#eee; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:30px; color:#888;">
                    <i class="fa-solid fa-user"></i>
                </div>
                <h3 id="p_name" style="margin:0; color:var(--primary);">Loading...</h3>
                <p id="p_sub" style="margin:5px 0 20px; color:var(--accent);">...</p>
                
                <div style="text-align:left;">
                    <div class="profile-row"><span class="p-lbl">Email</span><span class="p-val" id="p_email">-</span></div>
                    <div class="profile-row"><span class="p-lbl">Mobile</span><span class="p-val" id="p_mob">-</span></div>
                    <div class="profile-row"><span class="p-lbl">DOB</span><span class="p-val" id="p_dob">-</span></div>
                    <div class="profile-row"><span class="p-lbl">Address</span><span class="p-val" id="p_addr">-</span></div>
                    <div class="profile-row"><span class="p-lbl">Aadhaar</span><span class="p-val" id="p_aadhaar">-</span></div>
                </div>
                <p style="font-size:11px; color:red; margin-top:20px;">* To update details, please contact Admin.</p>
            </div>
        </div>

        <!-- HOMEWORK -->
        <div id="homeworkScreen" class="screen">
            <div class="fs-header"><i class="fa-solid fa-arrow-left" onclick="closeScreen('homeworkScreen')" style="padding:10px;"></i><span class="fs-title">Upload Homework</span></div>
            <div class="form-section">
                <div class="form-group"><label class="label">Subject (Locked)</label><input id="hw_subject" class="input" readonly style="background:#eee; color:#555;"></div>
                <div class="flex-row">
                    <div class="flex-col form-group"><label class="label">Class</label><select id="hw_class" class="input"><option>Nursery</option><option>LKG</option><option>UKG</option><option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option><option>VII</option><option>VIII</option><option>IX</option><option>X</option><option>XI</option><option>XII</option></select></div>
                    <div class="flex-col form-group"><label class="label">Section</label><input id="hw_sec" class="input" placeholder="A"></div>
                </div>
                <div class="form-group"><label class="label">Title / Topic</label><input id="hw_title" class="input"></div>
                <div class="form-group"><label class="label">Description</label><textarea id="hw_desc" class="input" rows="3"></textarea></div>
                <div class="form-group"><label class="label">Image (Optional)</label><input type="file" id="hw_file" class="input" accept="image/*"></div>
                <button class="btn btn-primary" onclick="uploadHomework()">Post Homework</button>
                <p id="hw_loading" style="display:none; color:blue; text-align:center;">Uploading...</p>
            </div>
            <div class="form-section">
                <h4>My Upload History</h4>
                <div id="hwList"></div>
            </div>
        </div>

        <!-- NOTICE -->
        <div id="noticeScreen" class="screen">
            <div class="fs-header"><i class="fa-solid fa-arrow-left" onclick="closeScreen('noticeScreen')" style="padding:10px;"></i><span class="fs-title">Send Notice</span></div>
            <div class="form-section">
                <div class="flex-row">
                    <div class="flex-col form-group"><label class="label">Class</label><select id="nt_class" class="input"><option>All</option><option>Nursery</option><option>LKG</option><option>UKG</option><option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option><option>VII</option><option>VIII</option><option>IX</option><option>X</option><option>XI</option><option>XII</option></select></div>
                    <div class="flex-col form-group"><label class="label">Section</label><input id="nt_sec" class="input" placeholder="A"></div>
                </div>
                <div class="form-group"><label class="label">Heading</label><input id="nt_head" class="input"></div>
                <div class="form-group"><label class="label">Notice Content</label><textarea id="nt_desc" class="input" rows="3"></textarea></div>
                <button class="btn btn-primary" onclick="sendNotice()">Send Notice</button>
            </div>
            <div class="form-section">
                <h4>Notice History</h4>
                <div id="noticeList"></div>
            </div>
        </div>

        <!-- LEAVE REQUESTS -->
        <div id="leaveScreen" class="screen">
            <div class="fs-header"><i class="fa-solid fa-arrow-left" onclick="closeScreen('leaveScreen')" style="padding:10px;"></i><span class="fs-title">Student Leaves</span></div>
            <div class="form-section">
                <h4>Pending Approvals</h4>
                <div id="leaveList">Loading...</div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBAUi1RVGdA9x6oo8XQ2zSyoR8gn1eCc4c", 
            authDomain: "coin-earn-app.firebaseapp.com",
            projectId: "coin-earn-app",
            storageBucket: "coin-earn-app.firebasestorage.app",
            messagingSenderId: "583026903249",
            appId: "1:583026903249:web:bb3653e1d159b2ce021df0"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let currentTeacher = {};

        // 1. AUTH LOGIC
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User Logged In
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                loadTeacherProfile(user.email);
            } else {
                // User Logged Out
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        function handleLogin() {
            const e = document.getElementById('login_email').value;
            const p = document.getElementById('login_pass').value;
            const msg = document.getElementById('login_msg');
            
            if(!e || !p) { msg.innerText = "Please fill email and password"; return; }
            msg.innerText = "Verifying...";

            auth.signInWithEmailAndPassword(e, p)
                .catch(err => {
                    msg.innerText = "Error: " + err.message;
                });
        }

        function logout() { auth.signOut(); location.reload(); }
        
        window.openScreen = function(id) { 
            document.getElementById(id).classList.add('active'); 
            if(id==='homeworkScreen') loadHomeworkHistory(); 
            if(id==='noticeScreen') loadNoticeHistory(); 
            if(id==='leaveScreen') loadLeaves(); 
            if(id==='profileScreen') renderProfile(); // Load Profile
        }
        window.closeScreen = function(id) { document.getElementById(id).classList.remove('active'); }

        // 2. FETCH TEACHER SUBJECT (LOCKED)
        function loadTeacherProfile(email) {
            db.collection("staff").where("email", "==", email).get().then(snap => {
                if (!snap.empty) {
                    const data = snap.docs[0].data();
                    currentTeacher = { id: snap.docs[0].id, ...data };
                    
                    document.getElementById('teacher_info').innerText = `${currentTeacher.name} | ${currentTeacher.subject}`;
                    document.getElementById('hw_subject').value = currentTeacher.subject;
                } else {
                    document.getElementById('teacher_info').innerText = "Profile Not Linked";
                    document.getElementById('hw_subject').value = "General";
                    alert("Welcome! Your email is not linked to a Staff profile in Admin Panel yet. You can still use the app but Subject will be 'General'.");
                }
            });
        }

        // NEW: RENDER PROFILE DETAILS
        function renderProfile() {
            document.getElementById('p_name').innerText = currentTeacher.name || "Unknown";
            document.getElementById('p_sub').innerText = currentTeacher.subject || "General";
            document.getElementById('p_email').innerText = currentTeacher.email || auth.currentUser.email;
            document.getElementById('p_mob').innerText = currentTeacher.mobile || "-";
            document.getElementById('p_dob').innerText = currentTeacher.dob || "-";
            document.getElementById('p_addr').innerText = currentTeacher.address || "-";
            document.getElementById('p_aadhaar').innerText = currentTeacher.aadhaar || "-";
        }

        // 3. UPLOAD HOMEWORK
        async function uploadHomework() {
            const cls = document.getElementById('hw_class').value;
            const sec = document.getElementById('hw_sec').value;
            const title = document.getElementById('hw_title').value;
            const desc = document.getElementById('hw_desc').value;
            const file = document.getElementById('hw_file').files[0];
            const subj = document.getElementById('hw_subject').value;

            if(!cls || !title || !desc) return alert("Please fill all fields");

            document.getElementById('hw_loading').style.display = 'block';
            let imgUrl = "";

            if(file) {
                const ref = storage.ref('homework/' + Date.now() + '-' + file.name);
                await ref.put(file);
                imgUrl = await ref.getDownloadURL();
            }

            db.collection("academics").add({
                type: "Homework",
                class: cls,
                section: sec,
                subject: subj, // Auto-filled
                title: title,
                desc: desc,
                image: imgUrl,
                date: new Date().toISOString().split('T')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                teacherEmail: auth.currentUser.email
            }).then(() => {
                alert("Homework Uploaded!");
                document.getElementById('hw_loading').style.display = 'none';
                document.getElementById('hw_title').value = "";
                document.getElementById('hw_desc').value = "";
                loadHomeworkHistory();
            });
        }

        function loadHomeworkHistory() {
            db.collection("academics")
              .where("teacherEmail", "==", auth.currentUser.email)
              .get().then(snap => {
                  let h = '';
                  snap.forEach(doc => {
                      const d = doc.data();
                      h += `<div class="manage-item">
                          <div><b>${d.class}-${d.section}: ${d.title}</b><br><small>${d.date}</small></div>
                          <i class="fa-solid fa-trash" style="color:red" onclick="deleteDoc('academics','${doc.id}')"></i>
                      </div>`;
                  });
                  document.getElementById('hwList').innerHTML = h || '<p style="text-align:center">No uploads yet</p>';
              });
        }

        // 4. SEND NOTICE
        function sendNotice() {
            const cls = document.getElementById('nt_class').value;
            const sec = document.getElementById('nt_sec').value;
            const head = document.getElementById('nt_head').value;
            const desc = document.getElementById('nt_desc').value;
            const subj = document.getElementById('hw_subject').value;

            if(!head || !desc) return alert("Fill details");

            db.collection("notices").add({
                headline: head + ` (${subj})`,
                details: desc,
                class: cls,
                section: sec,
                date: new Date().toISOString().split('T')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                teacherEmail: auth.currentUser.email
            }).then(() => {
                alert("Notice Sent!");
                document.getElementById('nt_head').value = "";
                document.getElementById('nt_desc').value = "";
                loadNoticeHistory();
            });
        }

        function loadNoticeHistory() {
            db.collection("notices")
              .where("teacherEmail", "==", auth.currentUser.email)
              .get().then(snap => {
                  let h = '';
                  snap.forEach(doc => {
                      const d = doc.data();
                      h += `<div class="manage-item">
                          <div><b>${d.headline}</b><br><small>${d.class} ${d.section || ''}</small></div>
                          <i class="fa-solid fa-trash" style="color:red" onclick="deleteDoc('notices','${doc.id}')"></i>
                      </div>`;
                  });
                  document.getElementById('noticeList').innerHTML = h || '<p style="text-align:center">No notices sent</p>';
              });
        }

        // 5. MANAGE LEAVES
        function loadLeaves() {
            document.getElementById('leaveList').innerHTML = 'Loading...';
            // Show all pending leaves
            db.collection("requests")
              .where("type", "==", "Leave")
              .where("status", "==", "Pending")
              .get().then(snap => {
                  let h = '';
                  snap.forEach(doc => {
                      const r = doc.data();
                      h += `<div class="manage-item" style="flex-direction:column; align-items:flex-start;">
                          <div style="width:100%; display:flex; justify-content:space-between;">
                              <b>${r.name}</b> <small>${r.class}-${r.section}</small>
                          </div>
                          <div style="font-size:12px; margin:5px 0; color:#555;">${r.detail}</div>
                          <div style="width:100%; display:flex; gap:10px; margin-top:5px;">
                              <button class="btn" style="background:var(--success); color:white; padding:5px;" onclick="updateLeave('${doc.id}', 'Approved')">Approve</button>
                              <button class="btn" style="background:var(--danger); color:white; padding:5px;" onclick="updateLeave('${doc.id}', 'Rejected')">Reject</button>
                          </div>
                      </div>`;
                  });
                  document.getElementById('leaveList').innerHTML = h || '<p style="text-align:center">No pending requests</p>';
              });
        }

        function updateLeave(id, status) {
            db.collection("requests").doc(id).update({ status: status, actionBy: currentTeacher.name })
              .then(() => { loadLeaves(); });
        }

        function deleteDoc(col, id) {
            if(confirm("Delete this item?")) {
                db.collection(col).doc(id).delete().then(() => {
                    if(col === 'academics') loadHomeworkHistory();
                    if(col === 'notices') loadNoticeHistory();
                });
            }
        }
    </script>
</body>
</html>
